# Micro-EQpolarity
**Micro-EQpolarity** is Jiachen Hu's code repository for polarity picking and focal mechanism analyses in Canada.

<div style="text-align: center;">
  <img src="https://github.com/hhhjjjcc/Micro-EQpolarity/blob/main/figure/toc2me_combinedV7.jpeg" width="70%">
  <p><b>Figure 1:</b> (a) Regional map of the ToC2ME study area (red box) in Alberta. (b) Map of the ToC2ME monitoring configuration with 69 stations, recording 21,619 events in ML -2.19 to 3.21.</p>
</div>

## Overview
This repository provides a comprehensive set of tools and workflows for working with the ToC2Me dataset. The main components of this repository are:

## 1. HASH Workflow

### Description

This section includes the process for solving focal mechanisms using the SKHASH on the ToC2Me dataset. Users can choose to either manually pick polarities or utilize the EQpolarity model for automatic polarity picking.

<div style="text-align: center;">
  <img src="https://github.com/hhhjjjcc/Micro-EQpolarity/blob/main/figure/workflow_transfer_learning_V7.jpeg" width="70%">
  <p><b>Figure 2:</b> Workflow for calculating focal mechanisms of microseismic events using transfer learning to adapt the EQpolarity model to microseismic P-wave first-motion polarity determination.</p>
</div>

---

## 2. Focal Mechanisms Analyses

### Description
This section includes a series of scripts showing analyses in the ToC2ME area based on FMSs, including spatial distribution, magnitude distribution, and FMS classification.

- Generated by [Code_ToC2ME/Focal_Mechanisms_Analyses/Mapping_size_magnitude.py](https://github.com/hhhjjjcc/Micro-EQpolarity/blob/main/Code_ToC2ME/Focal_Mechanisms_Analyses/Mapping_size_magnitude.py)
<div style="text-align: center;">
  <img src="https://github.com/hhhjjjcc/Micro-EQpolarity/blob/main/figure/Station_Locations_with_Focal_Mechanisms_testing_data_2558events_gray.png" width="70%">
  <p><b>Figure 3:</b> Map view of high-quality focal mechanism solutions in ToC2ME.</p>
</div>

- Generated by [Code_ToC2ME/Focal_Mechanisms_Analyses/plot_mechanisms_upgrade_with_average_mechanism_color_variation_for_group1.py](https://github.com/hhhjjjcc/Micro-EQpolarity/blob/main/Code_ToC2ME/Focal_Mechanisms_Analyses/plot_mechanisms_upgrade_with_average_mechanism_color_variation_for_group1.py) to [Code_ToC2ME/Focal_Mechanisms_Analyses/plot_mechanisms_upgrade_with_average_mechanism_color_variation_for_group_other_faults.py](https://github.com/hhhjjjcc/Micro-EQpolarity/blob/main/Code_ToC2ME/Focal_Mechanisms_Analyses/plot_mechanisms_upgrade_with_average_mechanism_color_variation_for_group_other_faults.py) 
<div style="text-align: center;">
  <img src="https://github.com/hhhjjjcc/Micro-EQpolarity/blob/main/figure/classificationV3.jpeg" width="50%">
  <p><b>Figure 4:</b> Classification of focal mechanism solutions in ToC2ME.</p>
</div>

- Generated by [Code_ToC2ME/Focal_Mechanisms_Analyses/Magnitude_Distribution_all_and_final_upgrade_with_numEQ_20241203.py](https://github.com/hhhjjjcc/Micro-EQpolarity/blob/main/Code_ToC2ME/Focal_Mechanisms_Analyses/Magnitude_Distribution_all_and_final_upgrade_with_numEQ_20241203.py)
<div style="text-align: center;">
  <img src="https://github.com/hhhjjjcc/Micro-EQpolarity/blob/main/figure/Magnitude_DistributionV2.jpeg" width="70%">
  <p><b>Figure 5:</b> Magnitude distribution of seismic events in ToC2ME in late 2016, with the right panel showing a frequency histogram at 0.1 magnitude intervals.</p>
</div>

---

## 3. Plot Waveforms on Focal Mechanisms

### Description
This section provides a script that enable users to plot waveforms directly with focal mechanism beachball diagrams. This feature helps validate the correctness of the mechanism solutions by allowing users to check waveforms and station locations.

- Generated by [Code_ToC2ME/Plot_waveform_on_mechanisms/Focal_mechanism_with_waveform_20241117_skhash.py](https://github.com/hhhjjjcc/Micro-EQpolarity/blob/main/Code_ToC2ME/Plot_waveform_on_mechanisms/Focal_mechanism_with_waveform_20241117_skhash.py)
<div style="text-align: center;">
  <img src="https://github.com/hhhjjjcc/Micro-EQpolarity/blob/main/figure/focal_mechanism_21034_Strike_Slip_Fault.png" width="70%">
  <p><b>Figure 6:</b> An example of an FMS with a magnitude of -1.07 and its corresponding polarity classification results as a function of back-azimuth.</p>
</div>

### Notes:
- In the ToC2ME dataset, waveform polarities are inverted.

---


## 4. EQpolarity Transfer Learning

### Description
This section demonstrates the application of transfer learning using EQpolarity models on the ToC2Me dataset.

<div style="text-align: center;">
  <img src="https://github.com/hhhjjjcc/Micro-EQpolarity/blob/main/figure/Eqpolarity_workflowV5.jpeg" width="70%">
  <p><b>Figure 7:</b> Architecture of the EQpolarity neural network for P-wave first-motion polarity determination.</p>
</div>

- Generated by [Code_ToC2ME/EQpolarity_Transfer_Learning/Training_Validation_curves.py](https://github.com/hhhjjjcc/Micro-EQpolarity/blob/main/Code_ToC2ME/EQpolarity_Transfer_Learning/Training_Validation_curves.py) and [Code_ToC2ME/EQpolarity_Transfer_Learning/CCT_ToC2ME_TransferLearning_20240926_For_Test_update20241013.ipynb](https://github.com/hhhjjjcc/Micro-EQpolarity/blob/main/Code_ToC2ME/EQpolarity_Transfer_Learning/CCT_ToC2ME_TransferLearning_20240926_For_Test_update20241013.ipynb)
<div style="text-align: center;">
  <img src="https://github.com/hhhjjjcc/Micro-EQpolarity/blob/main/figure/learning_curve_V4.jpeg" width="70%">
  <p><b>Figure 8:</b> Learning curves of Micro-EQpolarity trained on ToC2ME data, showing (a) loss and (b) accuracy for both training and validation sets with a threshold of 0.5. The best model is the one from epoch 9. Performance evaluation includes (c) precision-recall curves (d) ROC curves on ToC2ME test set.</p>
</div>

- Accuracy on Microseismic Events（ToC2ME）
Accuracy for each model can be obtained from [Code_ToC2ME/EQpolarity_Transfer_Learning/CCT_ToC2ME_TransferLearning_20240926_For_Test_update20241013.ipynb](https://github.com/chenyk1990/jiachenToc2Me/blob/main/Code_ToC2ME/EQpolarity_Transfer_Learning/CCT_ToC2ME_TransferLearning_20240926_For_Test_update20241013.ipynb)
The models are as follows
1. Blue: [model/SCSN/best_weigths_Binary_SCSN_Best.h5](https://github.com/chenyk1990/jiachenToc2Me/blob/main/model/SCSN/best_weigths_Binary_SCSN_Best.h5)
2. Orange: [model/Texas/best_weigths_Binary_Texas_Transfer10.h5](https://github.com/chenyk1990/jiachenToc2Me/blob/main/model/Texas/best_weigths_Binary_Texas_Transfer10.h5)
3. Red(Micro-EQpolarity): [model/Toc2me_20240819_Transfer_Learning_21916data/best_weigths_Binary_Toc2me_Transfer_SCSN_20241013_21916data_90.h5](https://github.com/chenyk1990/jiachenToc2Me/blob/main/model/Toc2me_20240819_Transfer_Learning_21916data/best_weigths_Binary_Toc2me_Transfer_SCSN_20241013_21916data_90.h5)
<div style="text-align: center;">
  <img src="https://github.com/chenyk1990/jiachenToc2Me/blob/main/Code_ToC2ME/EQpolarity_Transfer_Learning/Model_Comparison_on_Microseismic_Events.png" width="70%">
  <p><b>Figure 9:</b> Accuracy on the ToC2ME test dataset.</p>
</div>

---

## 5. Fine-scale fault structures revealed by focal mechanisms

### Description

This section focuses on two clusters: NSw in the western part of the study area, and SWe in the eastern part.

- Generated by [Code_ToC2ME/Fine-scale fault structures revealed by focal mechanisms/Strike_rake_mapping_with_mt_solution_for_group_classification_20241121_with_fms.py](https://github.com/hhhjjjcc/Micro-EQpolarity/blob/main/Code_ToC2ME/Fine-scale%20fault%20structures%20revealed%20by%20focal%20mechanisms/Strike_rake_mapping_with_mt_solution_for_group_classification_20241121_with_fms.py)
<div style="text-align: center;">
  <img src="https://github.com/hhhjjjcc/Micro-EQpolarity/blob/main/figure/group4_structure_V7.jpeg" width="70%">
  <p><b>Figure 10:</b> Spatial distribution of focal mechanism solutions across the study area.</p>
</div>

- Generated by [Code_ToC2ME/Fine-scale fault structures revealed by focal mechanisms/Mechanisms in NSw Earthquake Triggering/Time_vs_strike_v3.py](https://github.com/hhhjjjcc/Micro-EQpolarity/blob/main/Code_ToC2ME/Fine-scale%20fault%20structures%20revealed%20by%20focal%20mechanisms/Mechanisms%20in%20NSw%20Earthquake%20Triggering/Time_vs_strike_v3.py)
<div style="text-align: center;">
  <img src="https://github.com/hhhjjjcc/Micro-EQpolarity/blob/main/Code_ToC2ME/Fine-scale%20fault%20structures%20revealed%20by%20focal%20mechanisms/Mechanisms%20in%20NSw%20Earthquake%20Triggering/combined_plot_updated_v3.png" width="70%">
  <p><b>Figure 11:</b> Correlation within the NSw fault among hydraulic fracturing times for each well, focal mechanism strikes (normalized to 90°–270°) in the NSw fault, and injection rates.</p>
</div>

- Generated by [Code_ToC2ME/Fine-scale fault structures revealed by focal mechanisms/Fluid Diffusion Process in SWe/Fluid_diffusion.m](https://github.com/hhhjjjcc/Micro-EQpolarity/blob/main/Code_ToC2ME/Fine-scale%20fault%20structures%20revealed%20by%20focal%20mechanisms/Fluid%20Diffusion%20Process%20in%20SWe/Fluid_diffusion.m)
<div style="text-align: center;">
  <img src="https://github.com/hhhjjjcc/Micro-EQpolarity/blob/main/figure/Low_dip_corridor.jpeg" width="70%">
  <p><b>Figure 12:</b> Spatiotemporal fluid diffusion fit for low-dip faults in SWe.</p>
</div>

- Generated by [Code_ToC2ME/Fine-scale fault structures revealed by focal mechanisms/Fluid Diffusion Process in SWe/animation_SWe_with_time_select.py](https://github.com/hhhjjjcc/Micro-EQpolarity/blob/main/Code_ToC2ME/Fine-scale%20fault%20structures%20revealed%20by%20focal%20mechanisms/Fluid%20Diffusion%20Process%20in%20SWe/animation_SWe_with_time_select.py)
<div style="text-align: center;">
  <img src="https://github.com/hhhjjjcc/Micro-EQpolarity/blob/main/figure/Diffusion_Process_V3.jpeg" width="70%">
  <p><b>Figure 13:</b> Sequential earthquake activation process in SWe. Panels (a)–(f) illustrate the key moments marking the initiation of fault activation for Faults 1–6 as time progresses.</p>
</div>

<div style="text-align: center;">
  <img src="https://github.com/hhhjjjcc/Micro-EQpolarity/blob/main/figure/conceptual_FIgure_SWe.jpeg" width="70%">
  <p><b>Figure 14:</b> Schematic representation of the fluid diffusion process in SWe.</p>
</div>

---

## Data
1. ToC2ME all waveforms: https://doi.org/10.5281/zenodo.14185578

2. ToC2ME 2519 FMSs waveforms: https://doi.org/10.5281/zenodo.15165318

3. Texas data: Google Drive link: https://drive.google.com/drive/folders/1WXVB8ytNB4bOaZ97oq6OmMRyAEg95trp?usp=sharing

4. Texas_22980 data: https://doi.org/10.5281/zenodo.13901460

5. ToC2ME_Testing_data: In the `data` folder

---

## Environment Setup

To create and set up the required environment, follow these steps:

```bash
# Step 1: Create a Conda environment with Python 3.11.7
conda create -n eqp python=3.11.7

# Step 2: Activate the Conda environment
conda activate meqp

# Step 3: Install Jupyter Notebook
conda install ipython notebook

# Step 4: Install additional dependencies
pip install matplotlib==3.8.0 tensorflow==2.14.0 scikit-learn==1.2.2 seaborn==0.13.2

# optional
# obspy
conda install -c conda-forge obspy

# openpyxl
conda install openpyxl
```
---

## Reference
1. Chen Y, Saad OM, Savvaidis A, Zhang F, Chen Y, Huang D, Li H, Zanjani FA, 2024, Deep learning for P-wave first-motion polarity determination and its application in focal mechanism inversion. IEEE Transactions on Geoscience and Remote Sensing, 62, 5917411.
2. Skoumal, R.J., Hardebeck, J.L., Shearer, P.M. (2024). SKHASH: A Python package for computing earthquake focal mechanisms. Seismological Research Letters, 95(4), 2519-2526. https://doi.org/10.1785/0220230329
3. Fangxue Zhang, Ruijia Wang, Yunfeng Chen, and Yangkang Chen. Spatiotemporal variations in earthquake triggering mechanisms during multistage hydraulic fracturing in western Canada. Journal of Geophysical Research: Solid Earth, 127, 08 2022. doi: 10.1029/2022JB024744.
